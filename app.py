import streamlit as st

# ページ設定
st.set_page_config(
    page_title="CVS Trend Hunter (Deep & Wide)",
    layout="wide",
    initial_sidebar_state="expanded"
)

# セッション状態
if 'research_result' not in st.session_state:
    st.session_state.research_result = ""

st.title("🍩 コンビニスイーツ・パン 網羅的トレンド発掘ラボ")
st.markdown("---")

# サイドバー設定
st.sidebar.header("検索条件の設定")

# 1. 大枠のカテゴリー
broad_category = st.sidebar.selectbox(
    "1. 大カテゴリー",
    ["スイーツ", "パン", "総菜パン/軽食"]
)

# 2. サブジャンル
if broad_category == "スイーツ":
    sub_genres = [
        "指定なし（全域）",
        "シュークリーム・エクレア類",
        "プリン・カップデザート類",
        "ケーキ・スポンジ類",
        "チーズケーキ類",
        "チョコレート・焼き菓子類",
        "和菓子・ネオ和菓子類",
        "アイス・氷菓類",
        "★未定義・新食感・ハイブリッド（次世代のカヌレ/マリトッツォ枠）"
    ]
elif broad_category == "パン":
    sub_genres = [
        "指定なし（全域）",
        "食パン・食事パン系",
        "クロワッサン・デニッシュ系",
        "ハード系・ドイツパン系",
        "菓子パン（メロンパン等）系",
        "ドーナツ・揚げパン系",
        "★未定義・新食感・ハイブリッド（次世代の塩パン/生ドーナツ枠）"
    ]
else:
    sub_genres = [
        "指定なし（全域）",
        "サンドイッチ・バーガー類",
        "カレーパン・揚げ物入り類",
        "焼き込み・ピザ類",
        "中華まん・ホットスナック的パン",
        "★異業種かけ合わせ・新形態"
    ]

target_genre = st.sidebar.selectbox("2. 重点調査サブジャンル", sub_genres)

# 3. トレンドの「発生要因」フィルター
trend_axis = st.sidebar.multiselect(
    "3. トレンドの兆候・ベクトル（複数選択可）",
    [
        "食感の革新（とろとろ、ザクザク、生〇〇）",
        "ビジュアルインパクト（断面、巨大、極小）",
        "背徳感・高カロリー（ギルティ）",
        "ヘルシー・ギルトフリー（高タンパク、低糖質）",
        "レトロ・リバイバル（懐かしいものの再定義）",
        "異国情緒（韓国、イタリア、台湾、北欧など）",
        "一点突破型（専門店品質）"
    ],
    default=["食感の革新（とろとろ、ザクザク、生〇〇）"]
)

# 4. エリアと量
target_area = st.sidebar.text_input("4. 調査対象エリア", "日本国内（専門店・催事）、韓国、フランス、アメリカ、イタリア")
min_count = st.sidebar.slider("5. 最低収集件数の目安", 10, 50, 20, step=5)

# メインエリア：プロンプト生成
st.subheader(f"🔍 {broad_category} × {target_genre}")
st.caption("「数」を出しつつ、それぞれの「販売背景」も深く掘り下げるプロンプトを作成します。")

# ボタン
if st.button("Deep Research用プロンプトを生成"):
    # サブジャンル指示の構築
    genre_instruction = ""
    if "未定義" in target_genre:
        genre_instruction = f"""
        **【対象ジャンル：未定義・新種の発掘】**
        既存の「{broad_category}」のカテゴリに収まらない、**新しい形態、名称、食感を持つ商品**を優先的に探してください。
        （かつてのマリトッツォやカヌレのように、既存の枠組みの境界にあるもの、全く新しい名前がついているもの）
        """
    elif target_genre != "指定なし（全域）":
        genre_instruction = f"""
        **【対象ジャンル：{target_genre}】**
        基本はこのカテゴリを深掘りしますが、**このカテゴリから派生した進化系**や、**概念を覆すような新商品**（例：「飲む〇〇」「皮だけの〇〇」など）も積極的に含めてください。
        """

    prompt_text = f"""
あなたは徹底的な「トレンド・ハンター」です。
GeminiのDeep Research機能を使用し、以下の条件で可能な限り多くの情報を収集してください。

## 目的
{target_area}における、{broad_category}の「次なるヒットの原石」を**網羅的にリストアップ**すること。
「数（Volume）」と「詳細な情報（Context）」の両方が必要です。

## 収集方針（最重要）
1. **数に妥協しない**: スクープすべき商品は**可能な限り全て**挙げてください。目安として**最低{min_count}件以上**のリストアップを目指してください。「代表的な数個」で終わらせないでください。
2. **勝手な選別禁止**: コンビニに向くか向かないかは人間が判断します。少しでも「兆し」があるものは全てリストに入れてください。
3. **コンテキストの深掘り**: リストアップした全ての商品について、単なる商品説明だけでなく「どのような売り方がされているか」まで調査してください。

## 調査条件
* **重点ジャンル**: {target_genre}
    {genre_instruction}
* **トレンドの兆候**: {", ".join(trend_axis)}
* **ターゲット**: イノベーター・アーリーアダプター層（市場の先行16%）

## 出力フォーマット
各商品について、以下の情報をブロックごとに記述してください。
（表形式だと情報が入り切らないため、以下の見出し付きリスト形式で出力してください）

---
### 【No.X】 商品名 / トレンド名
**(ここに検索用キーワードや現地語の名称を併記)**

* **どんな商品か**:
    * 味、構成、食感（オノマトペを用いて具体的に）。
    * 見た目の特徴（写真映えのポイント）。
* **発祥とストーリー**:
    * どこの国、どの店（シェフ）が発祥か。何のリバイバルか。
* **販売現場のリアル（重要）**:
    * **どんな場所で？**: 路面店、百貨店、キッチンカー、スーパー、通販限定？
    * **どんな雰囲気で？**: おしゃれなブティック風、屋台で手渡し、レトロな包装紙？
    * **客層**: 行列の有無、メインの客層。
* **コンビニ担当者へのメモ**:
    * （AIの視点で）これをコンビニ商品化するなら、どの製品ライン（チルド、常温パン、ホットスナック）が近いか。
---

※ 上記のフォーマットで、見つかる限りのトレンドを{min_count}件以上、羅列してください。
"""
    st.code(prompt_text, language="text")
    st.success(f"👆 「最低{min_count}件」の網羅的な収集と、詳細なコンテキスト調査を両立させるプロンプトです。Gemini Advancedに入力してください。")

# 結果格納エリア
st.markdown("---")
st.subheader("📝 調査結果（大量リスト）のストック")

st.session_state.research_result = st.text_area(
    "Geminiからの大量の調査レポートをここに貼り付け",
    value=st.session_state.research_result,
    height=600
)

# 簡易的な整理機能
if st.session_state.research_result:
    st.markdown("---")
    st.subheader("📊 会議用リストへの変換")
    st.caption("大量の調査結果から、社内会議でパッと見せられる一覧表を作成します。")
    if st.button("一覧リストを作成"):
        formatting_prompt = f"""
あなたは編集者です。
以下の「大量のトレンド調査レポート」を、社内会議用の**一覧リスト（Markdownテーブル）**に変換してください。
詳細情報は削ぎ落とし、一目で全体像がわかるように要約してください。

## 原文データ
{st.session_state.research_result}

## 出力形式
| No | 商品名 | 特徴・食感（一言で） | 販売スタイル・雰囲気 | コンビニ商品化のヒント |
|---|---|---|---|---|
| 1 | ... | ... | ... | ... |
| 2 | ... | ... | ... | ... |

※ 全ての商品をリストに含めてください。
"""
        st.code(formatting_prompt, language="text")
        st.info("👆 このプロンプトをGeminiに入力すると、大量のテキストをスッキリした表に変換できます。")
