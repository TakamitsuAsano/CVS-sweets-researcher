import streamlit as st

# ページ設定
st.set_page_config(
    page_title="CVS Trend Hunter (Deep Dive)",
    layout="wide",
    initial_sidebar_state="expanded"
)

# セッション状態
if 'research_result' not in st.session_state:
    st.session_state.research_result = ""

st.title("🕵️‍♀️ コンビニスイーツ・パン 次世代トレンド発掘ラボ")
st.markdown("---")

# サイドバー設定
st.sidebar.header("検索条件の設定")

# 1. 大枠のカテゴリー
broad_category = st.sidebar.selectbox(
    "1. 大カテゴリー",
    ["スイーツ", "パン", "総菜パン/軽食"]
)

# 2. サブジャンル（動的に変化）
# 「カヌレのような新種」を拾うために、「その他・未定義・新ジャンル」を設ける
if broad_category == "スイーツ":
    sub_genres = [
        "指定なし（全域）",
        "シュークリーム・エクレア類",
        "プリン・カップデザート類",
        "ケーキ・スポンジ類",
        "チーズケーキ類",
        "チョコレート・焼き菓子類",
        "和菓子・ネオ和菓子類",
        "アイス・氷菓類",
        "★未定義・新食感・ハイブリッド（次世代のカヌレ/マリトッツォ枠）"
    ]
elif broad_category == "パン":
    sub_genres = [
        "指定なし（全域）",
        "食パン・食事パン系",
        "クロワッサン・デニッシュ系",
        "ハード系・ドイツパン系",
        "菓子パン（メロンパン等）系",
        "ドーナツ・揚げパン系",
        "★未定義・新食感・ハイブリッド（次世代の塩パン/生ドーナツ枠）"
    ]
else: # 総菜パン
    sub_genres = [
        "指定なし（全域）",
        "サンドイッチ・バーガー類",
        "カレーパン・揚げ物入り類",
        "焼き込み・ピザ類",
        "中華まん・ホットスナック的パン",
        "★異業種かけ合わせ・新形態"
    ]

target_genre = st.sidebar.selectbox("2. 重点調査サブジャンル", sub_genres)

# 3. トレンドの「発生要因」フィルター（ここが重要）
# 名詞ではなく「現象」で検索することで、ジャンル外のヒットを狙う
trend_axis = st.sidebar.multiselect(
    "3. トレンドの兆候・ベクトル（複数選択可）",
    [
        "食感の革新（とろとろ、ザクザク、生〇〇）",
        "ビジュアルインパクト（断面、巨大、極小）",
        "背徳感・高カロリー（ギルティ）",
        "ヘルシー・ギルトフリー（高タンパク、低糖質）",
        "レトロ・リバイバル（懐かしいものの再定義）",
        "異国情緒（韓国、イタリア、台湾、北欧など）",
        "一点突破型（専門店品質）"
    ],
    default=["食感の革新（とろとろ、ザクザク、生〇〇）", "異国情緒（韓国、イタリア、台湾、北欧など）"]
)

# 4. エリア
target_area = st.sidebar.text_input("4. 調査対象エリア", "日本国内（専門店・催事）、韓国、フランス、アメリカ、イタリア")

# メインエリア：プロンプト生成
st.subheader(f"🔍 {broad_category} × {target_genre} 詳細調査")

st.info(
    """
    **＜使い方のヒント＞**
    * 特定の「プリン」などを深く調べたい場合 → サブジャンルで「プリン」を選択。
    * **「まだ世にないカヌレのようなもの」を見つけたい場合** → サブジャンルで**「★未定義・新食感」**を選び、トレンドベクトルで「食感の革新」や「異国情緒」などを選んでください。
    """
)

if st.button("Deep Research用プロンプトを生成"):
    # プロンプトの組み立て
    
    # サブジャンルに関する特記事項
    genre_instruction = ""
    if "未定義" in target_genre:
        genre_instruction = f"""
        **【最重要検索指示】**
        既存の「{broad_category}」の定義に当てはまらない、**新しい形態、名称、食感を持つ商品**を優先的に探してください。
        （例：かつてのマリトッツォ、カヌレ、クイニーアマン、生ドーナツのように、既存カテゴリの境界線にあるものや、全く新しい名前がついているもの）
        """
    elif target_genre != "指定なし（全域）":
        genre_instruction = f"""
        **【検索範囲の指示】**
        基本的には「{target_genre}」のカテゴリを深掘りしてください。
        ただし、**このカテゴリから派生した進化系**や、**このカテゴリの概念を覆すような新商品**（例：「飲むプリン」「求肥で包んだシュー」など）は、カテゴリの枠を少しはみ出していても積極的に含めてください。
        """

    prompt_text = f"""
あなたは世界中のスイーツ・パン市場に精通した「トレンド・スカウト」です。
GeminiのDeep Research（または高度な検索機能）を使用し、以下の条件で徹底的なリサーチを行ってください。

## 調査テーマ
{target_area}における、{broad_category}の「次なるヒットの原石」発掘

## 調査条件
1. **重点ジャンル**: {target_genre}
2. **注目するトレンドの兆候**: {", ".join(trend_axis)}
3. **ターゲット層**: イノベーター理論におけるイノベーターおよびアーリーアダプター（市場の先行16%）。まだコンビニには並んでいないが、専門店やSNSの一部で熱狂を生んでいるもの。

{genre_instruction}

## 調査・出力項目（必須）
発見した各トレンド/商品について、以下のフォーマットで詳細にレポートしてください。
情報の解像度が低い（単に「美味しい」など）ものは除外してください。

### 【商品名・トレンド名】
**(ここに画像を検索させるための具体的なキーワードを併記)**

* **1. どんな商品か（What）**:
    * 味、構成要素、見た目の詳細。
    * 特に「食感（Texture）」と「シズル感」について具体的に記述。
* **2. 発祥と背景（Origin & Context）**:
    * どこの国、どの都市、どの店（シェフ）が発祥か。
    * なぜ今、それが受けているのか（過去の何のリバイバルか、何へのアンチテーゼか）。
* **3. 販売・展開のスタイル（Where & How）**:
    * **ここを詳細に調査してください。**
    * 販売場所の雰囲気（洗練されたブティック風？ 雑多なストリートフード風？ キッチンカー？）。
    * パッケージのデザイン（シンプル？ 映え重視？ 手持ちスタイル？）。
    * 価格帯と行列の有無。
* **4. 購入者・ファンの実態（Who）**:
    * どのような層が買っているか（Z世代、美意識高い系、サラリーマンの差し入れ需要？）。
    * SNSでどのようなタグ付けで投稿されているか。

## 出力形式
情報の見やすさを重視し、各アイテムごとに区切ってMarkdownで記述してください。
可能な限り、具体的な店名や固有名詞を出してください。
"""
    st.code(prompt_text, language="text")
    st.success("👆 これをDeep Researchに入力してください。「販売スタイル」や「購入者の実態」まで含めた深い調査を行います。")

# 結果格納エリア
st.markdown("---")
st.subheader("📝 調査結果のストック")
st.caption("Deep Researchから返ってきた詳細なレポートをここに保存し、企画のネタ帳として活用します。")

st.session_state.research_result = st.text_area(
    "Geminiからの調査レポートを貼り付け",
    value=st.session_state.research_result,
    height=600
)

# 簡易的な整理機能（企画提案への接続用）
if st.session_state.research_result:
    st.markdown("---")
    st.subheader("📊 簡易レポート出力")
    if st.button("調査結果を企画リスト形式に整形"):
        formatting_prompt = f"""
あなたは優秀な編集者です。
以下の「詳細な調査レポート」を読み込み、コンビニの商品開発担当者が会議で見やすいように、**「アイデア一覧リスト」**に要約・整形してください。

## 原文データ
{st.session_state.research_result}

## 整形ルール
以下の表形式（Markdown Table）にまとめてください。

| 商品・トレンド名 | 具体的な中身・食感 | 発祥・販売スタイルの特徴 | コンビニで展開する際のヒント（編集者コメント） |
| --- | --- | --- | --- |
| (名称) | (要約) | (例：NYのキッチンカーで、紙に包んで手渡しされるスタイル) | (例：レジ横のホットスナック什器で展開すると雰囲気が近くなるかも) |

※ 原文にある「販売スタイルの雰囲気」などの定性情報は非常に重要なので、削りすぎないようにしてください。
"""
        st.code(formatting_prompt, language="text")
        st.info("👆 このプロンプトを使うと、長い調査結果を「コンビニ会議用」のリストに変換できます。")
